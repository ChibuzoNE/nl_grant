<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Grants Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #667eea; margin-bottom: 10px; }
    .status {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 13px;
    }
    .grant-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
      background: white;
    }
    .grant-card h3 { color: #333; margin-bottom: 10px; }
    .provider { color: #667eea; font-weight: 600; margin-bottom: 10px; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background: #5568d3; }
    .error { background: #fee; border: 2px solid #fcc; color: #c33; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .success { background: #efe; border: 2px solid #cfc; color: #3c3; padding: 15px; border-radius: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Your Matching Grants</h1>
    <p style="color: #666; margin-bottom: 20px;">Grants discovered based on your profile</p>
    
    <div class="status" id="status">Initializing...</div>
    
    <div>
      <button onclick="testAPI()">Test API</button>
      <button onclick="loadGrants()">Load Grants</button>
      <button onclick="showDebug()">Show Debug Info</button>
    </div>
    
    <div id="results"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script>
    const STATUS = document.getElementById('status');
    const RESULTS = document.getElementById('results');
    
    // Config
    const SUPABASE_URL = 'https://ofxqmfaqkagilxuzyuwx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9meHFtZmFxa2FnaWx4dXp5dXd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMTc1OTIsImV4cCI6MjA4MDc5MzU5Mn0.83xOQCVSHRMDY7_TqZ4vTL3S3Q_uj33ljZkNjBrdY3E';
    
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    
    let supabase;
    
    function log(msg) {
      STATUS.innerHTML += '<br>' + msg;
      console.log(msg);
    }
    
    function showDebug() {
      log('URL: ' + window.location.href);
      log('User ID: ' + userId);
      log('Supabase loaded: ' + (typeof window.supabase !== 'undefined'));
      log('Client initialized: ' + (supabase !== undefined));
    }
    
    async function testAPI() {
      log('Testing Supabase connection...');
      
      try {
        if (!supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          log('‚úÖ Client created');
        }
        
        const { count, error } = await supabase
          .from('grants')
          .select('*', { count: 'exact', head: true });
        
        if (error) {
          log('‚ùå Error: ' + error.message);
          RESULTS.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
        } else {
          log('‚úÖ Connected! Total grants: ' + count);
          RESULTS.innerHTML = '<div class="success">Connected! Found ' + count + ' grants in database</div>';
        }
      } catch (e) {
        log('‚ùå Exception: ' + e.message);
        RESULTS.innerHTML = '<div class="error">Exception: ' + e.message + '</div>';
      }
    }
    
    async function loadGrants() {
      log('Loading grants...');
      
      try {
        if (!supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
        
        const query = userId 
          ? supabase.from('grants').select('*').eq('discovered_by_user_id', userId).limit(20)
          : supabase.from('grants').select('*').limit(10);
        
        const { data: grants, error } = await query;
        
        if (error) {
          log('‚ùå Error: ' + error.message);
          RESULTS.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
          return;
        }
        
        log('‚úÖ Found ' + grants.length + ' grants');
        
        if (grants.length === 0) {
          RESULTS.innerHTML = '<div class="error">No grants found for user ' + userId + '</div>';
          return;
        }
        
        const html = grants.map(g => `
          <div class="grant-card">
            <h3>${g.grant_name || 'Untitled'}</h3>
            <div class="provider">${g.provider || 'Unknown'}</div>
            <p>${g.description || g.ai_summary || 'No description'}</p>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
              Eligibility: ${g.eligibility || 'Not specified'}
            </div>
          </div>
        `).join('');
        
        RESULTS.innerHTML = '<div class="success">Found ' + grants.length + ' grants!</div>' + html;
        
      } catch (e) {
        log('‚ùå Exception: ' + e.message);
        RESULTS.innerHTML = '<div class="error">Exception: ' + e.message + '</div>';
      }
    }
    
    // Auto-initialize
    window.addEventListener('load', function() {
      log('Page loaded');
      log('User ID: ' + (userId || 'MISSING'));
      
      if (typeof window.supabase === 'undefined') {
        log('‚ùå Supabase library not loaded!');
      } else {
        log('‚úÖ Supabase library loaded');
        setTimeout(testAPI, 500);
      }
    });
  </script>
</body>
</html>
